# 关于embedded-tomcat的学习

## Servlet 3.0+ 接口
1. Servlet 3.0+ 支持编程式来注册用户的servlet和filter.通过javax.servlet.ServletContainerInitializer.onStartup来完成的.
2. spring-boot的org.springframework.boot.web.servlet.ServletContextInitializer与javax.servlet.ServletContainerInitializer仅仅包名不同,类型相同.
3. spring-boot的ServletContextInitializer是spring-boot层面的对编程式注册servlet/filter的抽象,用来完成具体的注册过程.
4. spring-boot的ServletContextInitializer是被封装到TomcatStarter,来被servletContext调用的.
5. spring-boot的RegistrationBean就是对


## tomcat实例化和初始化过程(发生在refresh阶段)
1. ServletWebServerApplicationContext容器在refresh的时候,会创建WebServer
2. TomcatServletWebServerFactory来负责具体的WebServer创建工作.
3. 创建Tomcat实例过程中,Tomcat为其构造合适的Server/Service/Connector/Engine/Host;TomcatServletWebServerFactory为Tomcat构造Context(即TomcatEmbeddedContext).
4. TomcatServletWebServerFactory为Context配置contextPath
5. TomcatServletWebServerFactory将所有的spring-boot的org.springframework.boot.web.servlet.ServletContextInitializer以TomcatStarter(implements javax.servlet.ServletContainerInitializer)的形式配置到Context中
6. TomcatStarter中有一个ServletContextInitializer是selfInitialize,由ServletWebServerApplicationContext提供的,即ServletWebServerApplicationContext.selfInitialize.
7. selfInitialize在用来将ServletWebServerApplicationContext容器配置到servletContext的attribute中,即root-WebApplicationContext;selfInitialize并不在root-WebApplicationContext
8. selfInitialize然后回调容器中的所有ServletContextInitializer,达到将filter/servlet注册到servletContext中.
9. 将Tomcat以构造参数的形式配置到TomcatWebServer,然后开始执行TomcatWebServer的initialize
10. TomcatWebServer将tomcat的Connector先临时移除,然后调用Tomcat.start,触发tomcat的启动逻辑(因为Connector先临时移除了,此时相当于是初始化过程).
11. tomcat启动server/service/engine.其中engine将host的启动放在线程池中执行;
12. host初始化context,触发javax.servlet.ServletContainerInitializer.onStartup执行,即触发TomcatStarter执行;
13. TomcatStarter执行中,由DispatcherServletRegistrationBean,将DispatcherServlet 注册到servlet容器中;还有一些其他的FilterRegistrationBean(注册OrderedCharacterEncodingFilter/OrderedFormContentFilter/OrderedRequestContextFilter)
14. 因为tomcat的线程都是daemon线程,所以TomcatWebServer启动一个非daemon线程,防止tomcat结束.该线程监听到SHUTDOWN命令后,才结束线程.

## tomcat启动过程(发生在finishRefresh阶段)
1. 在ApplicationContext#finishRefresh中会通知LifecycleProcessor事件onRefresh(即容器已经刷新完成),触发auto-starting components
2. WebServerStartStopLifecycle implements SmartLifecycle,是AutoStartup.触发WebServer#start
3. TomcatWebServer执行start具体工作,将临时移除的Connector归还,此时tomcat才算是从初始化完成到启动完成.
4. WebServerStartStopLifecycle发布ApplicationEvent(即ServletWebServerInitializedEvent),只有ServerPortInfoApplicationContextInitializer关注这个事件,将server的port信息放到environment中


